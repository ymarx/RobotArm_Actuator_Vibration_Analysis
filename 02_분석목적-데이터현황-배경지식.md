# CP25_RANUM[PLAN]통합본(공유-작업용) (1)

Created: 2025년 11월 17일 오전 11:24

# 1. 프로젝트 목적 및 성공 기준

## 1.1 1차 목적: 양불(PASS/FAIL) 판정기의 구축(프로덕션 적용)

**핵심 요지**

- CORE100/CORE200 액추에이터의 **진동/자이로 데이터로 양불(PASS/FAIL) 자동 판정**을 수행하는 **프로덕션급 판정기**를 만든다.
- 입력은 **CSV 한 파일(1회 구동 기록)**, 출력은 **시료 단위 판정(PASS/FAIL + 근거)**이다.

**왜 중요한가**

- 관능(청진) 의존은 사람/환경에 따라 흔들린다. 자동 판정은 **일관성·재현성**을 제공한다.
- 출하 QC에서 미탐(FN)은 비용/리스크가 크고, 오탐(FP)은 생산성 저하를 유발한다. **정밀도와 재현율의 균형**이 핵심이다.

**무엇을 할 것인가**

- 파일을 **8초 윈도(50% 중첩)**로 나눠 윈도 단위 **특징(피처)**을 추출하고, **윈도 모델**이 확률을 낸다.
- 윈도 확률을 **파일→시료**로 집계(파일 내 max, CW/CCW 중 max)하여 **최종 판정**을 만든다.
- 모델 확률과 함께 **하이브리드 룰(2×/1×, 고주파 대역RMS, CF)**을 OR 결합해 **안전망**을 갖춘다.
- 결과에는 **근거(주파수 피크·대역 에너지·CF·QC 플래그)**를 함께 제공한다.

**체크리스트 / 산출물**

- [ ]  윈도 분할 규격: 8 s, 50% 중첩 고정
- [ ]  모델: XGBoost 윈도 분류기 + 임계(τ) 탐색
- [ ]  하이브리드 룰: (2×/1×>T1) OR (rms_50_150>T2) OR (CF>T3)
- [ ]  산출물: `models/model.json`, `models/threshold.json`, 리포트(근거 포함)

---

## 1.2 2차(연속) 목적: 원인 후보(언밸런스/정렬/기어/베어링/공진) 탐색 기반 마련

**핵심 요지**

- 1차 목적(양불 판정) 이후를 대비해, **원인 분석을 위한 단서(피처 체계/리포트 템플릿)**를 현재 단계에서부터 구조화한다.

**왜 중요한가**

- QC 판정만으로는 “왜 나쁜지”를 설명하기 어렵다. **후속 개선·설계 보완**에는 원인 후보를 좁히는 신호가 필요하다.

**무엇을 할 것인가**

- **1×/2×/고조파** 및 **기어메시(사이드밴드)**, **고주파 대역 에너지(50–150 Hz)**, **CF·커토시스(충격성)** 등을 표준 피처로 기록.
- **자이로–가속도 동시 피크** 여부(회전성 근거) 플래그화.
- *포락(Envelope)**은 현 샘플링(≤150 Hz) 조건에서 **보조 지표**로만 사용(로그/그래프에 표기).

**체크리스트 / 산출물**

- [ ]  리포트에 1×/2× 라벨, 2×/1× 비, 대역RMS, CF 자동 표기
- [ ]  “원인 후보” 섹션(언밸런스/정렬/기어/베어링/공진) 체크리스트 자리표시자
- [ ]  포락/사이드밴드 값은 **보조**로 라벨링(주의 문구 포함)

---

## 1.3 성공 지표(KPI): 재현율/정밀도, 오탐/미탐 허용 범위, 처리시간, 근거 시각화 품질

**핵심 요지**

- **정량 KPI**(정밀도·재현율·처리시간)와 **정성 KPI**(근거 품질·설명가능성)를 명시해 운영 결정을 투명하게 한다.

**왜 중요한가**

- QC는 **미탐(FN) 최소화**가 특히 중요하지만, **오탐(FP)**이 과도하면 생산성에 타격.
- 처리시간은 라인 택타임에 맞아야 하고, 근거 시각화가 있어야 **신뢰**를 얻는다.

**무엇을 할 것인가**

- **평가 계층**: 윈도 수준 + 시료 수준(파일→CW/CCW 집계).
- **임계(τ) 정책**: **Precision ≥ P₀(예: 0.80)** 제약 하 **Recall 최대화**.
- **처리시간 KPI**: 파일당 전처리+피처+판정 **≤ X초**(초기 목표: 데이터/머신 환경에 맞게 설정).
- **근거 품질 체크리스트**:
    - 1×/2× 라벨 정확성(시각적 확인), 대역 강조(1–10/10–50/50–150 Hz),
    - CF·커토시스·2×/1×·포락(보조) 수치 표식,
    - QC 플래그(불연속/포화/편향) 명시.

**체크리스트 / 산출물**

- [ ]  **정밀도 하한 P₀**(초기 0.80, 협의 가능) 문서화
- [ ]  시료 레벨 지표(혼동행렬, P/R/F1) 및 윈도 레벨 지표 동시 보고
- [ ]  평균 처리시간, 95% 처리시간 기록
- [ ]  리포트에 **피크/대역/CF/QC** 오버레이 그래프 포함

---

## 1.4 운영 관점 요구사항: 결과 신뢰성(근거 제시), 재현성, 리포트 자동화, 버전관리

**핵심 요지**

- **결과를 믿을 수 있어야** 하고(**근거**), 누구나 **같은 결과**를 재현해야 하며(**재현성**), **자동 리포트**가 생산되어야 하고, 모든 구성요소는 **버전 관리**되어야 한다.

**왜 중요한가**

- QC 의사결정은 제조/출하를 좌우하므로, **추적 가능성**과 **롤백**이 필수.
- 사람 교체/환경 변화에도 **동일 판정**이 나와야 한다.

**무엇을 할 것인가**

- **재현성**: YAML 설정 고정(윈도 길이/필터/PSD 파라미터), 난수 시드 고정, 그룹 분할 기록(`splits/split_v1.json`).
- **근거 리포트 자동화**: 파일/시료별 **확률·임계·룰 히트·1×/2× 라벨·대역RMS·CF·QC 플래그**를 자동 수록.
- **버전관리/거버넌스**:
    - `models/model.json`, `models/feature_schema.json`, `models/threshold.json` 버전 태깅
    - **릴리즈 노트**(데이터 범위/분할/성능/변경점)와 **N-1 롤백** 절차
    - **의사결정 로그**(시료별 최종판정/근거/그림 링크) 6–12개월 보관
- **운영 임계·룰 재보정**: 분기/반기 정책, **경계 PASS**(τ±Δ나 룰-전용 히트)의 현장 확인 큐 운영.

**체크리스트 / 산출물**

- [ ]  설정 파일: `configs/*.yaml` (EDA, Dataset, Train) 저장/버전
- [ ]  아티팩트: `model.json`, `feature_schema.json`, `threshold.json` + 리포트
- [ ]  의사결정 로그/도메인 근거 포함(추후 감사 대비)
- [ ]  **OPS 런북**: 임계 재보정·룰 업데이트·이상 급증 대응 절차

---

### 부록: 초보자를 위한 1페이지 요약(핵심만)

- **하고 싶은 일**: 센서 데이터로 **자동 PASS/FAIL** 판단.
- **어떻게?** 파일→8초 윈도 분할→피처 추출→윈도 모델 확률→파일 max→CW/CCW max→시료 판정.
- **정책**: **정밀도 하한(P₀)을 지키면서 재현율 최대로.** 모델 + 간단한 룰(2×/1×/대역RMS/CF) **OR** 결합.
- **근거**: 1×/2× 피크, 대역 에너지, CF, QC 플래그 **그래프/표로 자동 출력**.
- **운영**: 설정/모델/임계 **버전 관리** + **릴리즈/롤백** + 주기적 **재보정**.

# 2. 데이터 현황 및 구조

## 2.1 측정 파일 구조

### 2.1.1 CSV 상단 메타(제품/시료/조건/필터/리샘플링 등)

- 파일 맨 위 1~21행은 **메타정보.**
    - 예: 측정 위치, 저장 경로, **Resampling=512**, **LowFreq=1**, **HighFreq=150**, **x/y/z RMS/Peak** 등.
- 메타에 적힌 **리샘플링/필터 대역(1–150 Hz)** 정보는 **전처리 전략**(필터 재적용 여부, 비교 기준)을 결정

---

### 2.1.2 실데이터 헤더

**헤더 열**

```
TimeStamp, acc-X, acc-Y, acc-Z, Gyro-X, Gyro-Y, Gyro-Z, acc-Sum

```

- **TimeStamp: 단위** ms(밀리초)
- *acc-***는 선형 가속도(흔들리는 세기), **Gyro-***는 각속도(회전 흔들림), **acc-Sum**은 합성 진동(벡터합)

**헤더 자동 탐색 필요**

- 헤더가 항상 같은 줄(예: 24행)에 있지 않을 수 있으니, **내용으로  파일 파싱, 정리 필요.**
    - 규칙: “`TimeStamp` 문자열이 있고, `acc-`가 포함된 열이 2개 이상”인 줄을 **헤더**로 인식.

**체크리스트**

- [ ]  헤더 **내용 기반** 탐색(행번호 고정 금지)
- [ ]  필수 열이 모두 있는지 검사(TimeStamp, acc-X/Y/Z, acc-Sum; Gyro-X/Y/Z는 선택이지만 강력 권장)

---

### 2.1.3 샘플링: 약 512 Hz (TimeStamp 간격 1.953125 ms)

- 인접한 두 TimeStamp 차(Δt)의 **중앙값**이 약 **1.953 ms** → **fs ≈ 512 Hz** 입니다.
    1. `Δt_i = TimeStamp[i] - TimeStamp[i-1]` (ms)
    2. `median_Δt = median(Δt_i)`
    3. `fs = 1000.0 / median_Δt` (Hz)

**체크리스트 (데이터 정제)** 

- [ ]  `fs`가 510~514 Hz 범위(±1% 이내)인지 확인
- [ ]  비정상(±1% 이상)이면 **타임스탬프 불연속** 플래그

---

### 2.1.4 파일 길이: 27k~29k 샘플(≈53~57 s)

**쉽게 설명**

- 한 파일은 **약 1분 내외**(환경에 따라 ±).
- 파일 길이가 지나치게 짧거나 길면 **중간 정지/재시작** 등의 이슈 가능

**체크리스트**

- [ ]  표본 수가 27k~29k인지(±10% 허용)
- [ ]  벗어나면 QC 로그에 “길이 이상” 기록

---

### 2.1.5 조건: CW/CCW(회전 방향), 세그 번호(예: cw4/ccw4)

**쉽게 설명**

- **CW**(시계방향), **CCW**(반시계방향)으로 각각 측정했고, 파일명에 **`cw4`/`ccw4`*처럼 **회차/세그먼트 번호**
- 같은 시료여도 **CW/CCW는 다른 파일**
    
    → 나중에 **시료 판정**은 두 방향 중 **더 나쁜 쪽(max)** 선택 방식 고려
    

**체크리스트**

- [ ]  파일명에서 product(100W/200W), sample 번호, direction(CW/CCW), run/seg 번호 파싱
- [ ]  시료 단위 식별에 (product, sample) 키 사용

---

## 2.2 시료 체계

### 2.2.1 CORE 100(100W) 20*2개 (cw, ccw)/ CORE 200(200W) 20*2개 (cw, ccw)

**쉽게 설명**

- 제품 2종(100W/200W), **각 40개 시료**
- 각 시료당 CW/CCW 파일이 존재하므로, **시료 × 방향 × 회차**

**체크리스트**

- [ ]  시료 수 통계: 제품별 20개 확인
- [ ]  파일 누락/중복 여부 점검

---

### 2.2.2 시료ID·파일명 규칙(파서 설계 기준)

**예시 파일명**

```
100W_Sample03 ccw4_2025-11-07 03-35-27.csv

```

**파싱 항목** 

- `product`: 100W or 200W
- `sample`: 정수
- `direction`: CW or CCW
- `run_id`: 정수(예: 4)
- `datetime`: 선택(로그용)

**안정적인 정규식(예시)**

- 공백/밑줄 변형을 허용하는 범용 패턴:

```
(100W|200W)[_\s-]*Sample\s*(\d+)[\s_]+(cw|ccw)\s*(\d+).*?\.csv$

```

- 대소문자 무시 플래그 사용 (`re.I`).

**체크리스트**

- [ ]  파싱 실패 시 **파일 스킵 금지**, 오류 로그에 기록(수동 수선 목록)
- [ ]  키 `(product, sample, direction, run_id, filename)`를 **모두** 보관

---

## 2.3 라벨(관능) 현황

### 2.3.1 정상/소음/진동/표기없음 – 발주처 해석 지침

**쉽게 설명**

- **정상**: 명백한 이상 없음
- **소음**: 관능상 약한 이음/간헐 튐(경계 사례)
- **진동**: 명시적 이상
- **표기없음**: 불명확(운영상 **불량 취급** 권장)

**권장 이원분류**

- **PASS** = 정상 + 소음
- **FAIL** = 진동 + 표기없음

---

### 2.3.2 정상 극소(100W 시료 중 1개) 문제와 불균형

설명

- “정상” 표본이 극히 적어 모델이 **정상 패턴**을 충분히 학습하기에 불충분

**대응**

- 파일을 **8초 윈도**로 나눠 표본 수를 늘림(weak labeling).
- 분할은 **(product, sample)** 그룹 기준으로 (CW/CCW 함께) → **누수 방지**.

---

### 2.3.3 레이블 신뢰도/가중치 설정

**핵심 정책**

- “소음”은 **경계 PASS** → 학습 시 **sample_weight=0.5** 또는 **target smoothing=0.8**.
- 평가/운영 시에는 **하드 라벨**(PASS/FAIL) 기준으로 판단.

**체크리스트**

- [ ]  `label_bin`, `y_bin`, `y_bin_smooth`, `weight` 컬럼 생성
- [ ]  “소음” 처리 정책(가중/스무딩) YAML로 고정

---

## 2.4 시험전 시료 표기 (엑셀 파일)

### 2.4.1 tidy 변환 규칙(제품/시료/라벨 Long 형태)

- 다양한 표기 형식의 엑셀을 **세 열**로 정리합니다:
    
    ```
    product,sample,label
    100W,0,정상
    100W,1,소음
    200W,1,진동
    ...
    
    ```
    
- 이걸 **labels_tidy.csv**로 저장해 **모든 조인**의 기준으로 활용

**스텝 바이 스텝**

1. 엑셀에서 제품/시료/라벨을 추출(머리글 한국어/영어 혼용 주의).
2. 제품은 `100W/200W`로 표준화(대문자, 공백 제거).
3. 시료는 **정수**로 통일(문자 03 → 3).
4. 라벨은 {정상, 소음, 진동, 표기없음} 중 하나로 정규화.

**체크리스트**

- [ ]  오탈자/공백 제거
- [ ]  라벨 집합 외 값은 결측 처리 후 목록화(수기 확인)

---

---

## 2.5 데이터 품질 점검

### 2.5.1 드롭/결측/포화, 타임스탬프 불연속

**쉽게 설명**

- **드롭/결측**: 신호가 잠깐 끊김/비정상 값.
- **포화**: 센서 최대/최소 근처에서 값이 **납작**(클리핑).
- **불연속**: TimeStamp가 **튀거나 멈춤**.

**스텝 바이 스텝(QC 플래그)**

- **불연속**: `Δt > 2×median(Δt)`인 이벤트 개수/비율 기록
- **포화**: |x| ≥ p99.9 수준이 **연속 n샘플 이상**인지(채널별)
- **결측**: NaN 또는 비수치(문자) → 강제 숫자화 후 NaN 비율 기록

**체크리스트**

- [ ]  `qc_discontinuity_count`, `qc_saturation_ratio`, `qc_nan_ratio` 컬럼
- [ ]  파일/윈도 기준 QC 이슈는 리포트/로그에 표시

---

### 2.5.2 센서 오프셋/축 정렬 정보 부재

**쉽게 설명**

- 설치 방향/오프셋이 미세하게 다르면, 축별 진폭 비교가 **직관적**이지 않을 수 있습니다.

**대응**

- 벡터합(**acc-Sum**)과 **대역RMS**(1–10/10–50/50–150 Hz) 같은 **축 불변 지표**를 주요 기준 삼음
- **축별 차이**는 보조 참고로 활용

**체크리스트**

- [ ]  주요 판단지표: acc-Sum 기반(또는 축별 평균/백분위 병기)
- [ ]  제품별 센서 정렬 사양 입수 시 문서화(향후 보정 가능)

---

### 2.5.3 밴드(1–150 Hz) 사전 적용 여부와 재적용 방침

**상황**

- 메타에 `LowFreq=1, HighFreq=150`로 **이미 필터링**·리샘플링된 흔적

**정책**

- 분석 파이프라인에서는 **항상 동일 전처리**를 적용해 **재현성**을 확보
- 단, **이중 필터링**의 부작용을 피하기 위해 다음을 지킵니다:
    1. **메타 점검**: 기존 필터 대역이 1–150 Hz로 표기되면,
    2. **재필터**는 **동일 또는 살짝 넓은 버퍼 대역**(예: 0.8–160 Hz)으로 적용하거나,
    3. **동일 1–150 Hz**로 적용하되 **RMS 변화율**을 체크: `|RMS_after/RMS_before - 1| ≤ 5%`이면 OK, 초과 시 QC 경고.

**체크리스트**

- [ ]  재필터 적용 후 **RMS 변화율** 로그
- [ ]  변화율 과다 파일을 **경계 PASS** 후보로 표기(리뷰 큐)

---

## 부록 A (파형 분석)

- **파일 = 긴 음악 트랙**, **윈도 = 8초 샘플(클립)**. 트랙 전체 평이(라벨)가 있어도, 잡음은 특정 클립에만 있을 수 있다.
- **acc**는 **소리 크기(진폭)**에 비유, **gyro**는 **바이브/떨림의 회전성**. 두 신호가 같은 리듬(주파수)을 보이면 **회전 원인**일 가능성이 크다.
- *1×/2×**는 **기본 박자/2배 박자**, **사이드밴드**는 **떨리는 보컬의 비브라토**처럼 메인 톤 양옆에 생기는 무늬다.

## 부록 B (현장 체크리스트)

1. **메타 확인**: Resampling/LowFreq/HighFreq/Check 값을 기록
2. **헤더 자동 탐색**: 내용으로 헤더 줄을 찾고 컬럼 이름 확정
3. **fs 계산**: TimeStamp로 512 Hz 확인(±1% 이내)
4. **길이 점검**: 27k~29k 샘플(±10% 이내)
5. **파일명 파싱**: product/sample/direction/run_id 추출; 실패 시 로그
6. **라벨 tidy 조인**: (product, sample) 키로 결합, “소음” 처리 정책 반영
7. **QC 플래그**: 불연속/포화/결측율 기록 → 리포트에 표시
8. **필터 정책**: 1–150 Hz 표준 전처리, RMS 변화율로 과도한 변형 감시

# 3. 도메인 지식 요약

## 3.1 회전기계 진동의 기본: 1×/2×/고조파, 구조 공진, 대역 에너지

**쉽게 설명**

- **1×**: 축이 한 바퀴 돌 때 한 번 나타나는 기본 흔들림(기본 회전수).
- **2×/3× …(고조파)**: 1×의 정수배 박자. 샤프트 정렬 불량, 헐거움, 비대칭 하중에서 잘 생김.
- **구조 공진**: 기계의 고유진동수(그 주파수에서 작은 힘도 크게 흔들림).
- **대역 에너지**: 특정 주파수 구간(예: 50–150 Hz)에서 “얼마나 세게 흔들렸나”를 RMS로 본 값.

**왜 중요한가**

- 1×/2×/고조파 패턴과 대역 에너지는 **원인 후보**(언밸런스, 정렬, 헐거움)를 빠르게 좁히는 가장 강력한 단서입니다.
- 공진 근처에서는 정상도 **크게 떨릴 수** 있으므로, “크다=무조건 불량”이 아닙니다 → **패턴과 맥락**이 더 중요.

**스텝 바이 스텝 — 기본 스펙트럼 읽기**

1. **밴드패스(1–150 Hz)** 후 FFT/PSD를 계산합니다(윈도 8 s, Hann, nperseg=1024 권장).
2. *가장 큰 피크(pmax_f)**를 잡고 `~0.3–50 Hz` 구간에서 **기본 후보**를 찾습니다.
3. 그 주파수의 **정수배(2×, 3×)** 위치에 피크가 줄줄이 있나 확인합니다.
4. **대역RMS**를 보기 좋게 3구간으로 봅니다: `[1–10], [10–50], [50–150] Hz`.
5. **공진 의심**: 기존 피처(2×/1× 비율 등)와 달리 **좁은 구간**에서 예외적으로 과도하면 주의 메모.

**체크리스트 / 주의점**

- [ ]  1× 후보는 0.3–50 Hz에서 찾고, 2×/3× 정수배를 확인
- [ ]  대역RMS 50–150 Hz가 비정상적으로 크면 “고주파성/충격성” 힌트
- [ ]  공진이 의심되면 “속도/경로 변경 시” 진폭 변화를 추가 기록

---

## 3.2 기어박스(하모닉 포함) 진동: GMF, 사이드밴드(±n×), 백래시/편심 사인

**쉽게 설명**

- **GMF(Gear Mesh Frequency)**: 기어가 서로 맞물리며 이빨이 지나가는 속도 → 일반적으로 `GMF ≈ 회전속도 × 치수`.
- **사이드밴드(±n×)**: GMF(혹은 캐리어 성분) 주변에 **±(회전수의 정수배)** 간격으로 생기는 “작은 이빨”. **속도/편심/백래시**의 **변조 흔적.**
- **하모닉 드라이브**는 고감속(치수 많음)이라 **GMF 자체는 고주파**가 되기 쉬워, 현재 대역(≤150 Hz)에서는 **직접 측정이 어려움**. 대신 **낮은 쪽에 내려온 변조/사이드밴드 패턴**이 힌트가 됨.

**왜 중요한가**

- 기어 문제는 종종 **사이드밴드 패턴**으로 눈에 띕니다. GMF가 대역 밖이어도, **변조 신호가 대역 내에 남는 경우**가 많음.

**스텝 바이 스텝 — 사이드밴드 힌트 찾기**

1. 스펙트럼에서 **뚜렷한 고정 주파수(캐리어)**를 한두 개 선택
2. 그 **좌우를 확대**해 **±d, ±2d …** 간격으로 “톱니”가 반복되는지 확인. 여기서 `d ≈ 1×(추정)`.
3. **사이드밴드 지표**(예: 좌/우 1~2쌍의 진폭 합 ÷ 캐리어 진폭)를 계산해 **로그.** 
4. 캐리어의 **시간 변화**(속도 변화)와 사이드밴드 간격 변화가 같이 움직이면 **변조성** 가능성↑.

**체크리스트 / 주의점**

- [ ]  GMF 직접 검출이 어렵다면 “**사이드밴드 간격≈1×**” 가설로 변조성 확인
- [ ]  “백래시/편심” 의심 시 **다수 하모닉 + 뚜렷한 사이드밴드**가 함께 늘어나는지 관찰

---

## 3.3 베어링 결함과 포락(Envelope): 원리, 적용 가능성(현 샘플링의 제약)

**쉽게 설명**

- 베어링 결함(내륜/외륜/소체/케이지)은 **충격성** 신호로 나타나고, 고주파 대역의 진폭이 증가.
- *포락 분석(Envelope)**은 “고주파 대역의 진폭 변화를 껍질(Envelope)로 씌워 저주파로 내려서 보는” 기법(AM 복조와 유사).

**왜 중요한가**

- 포락은 **초기 베어링 결함**의 민감한 지표입니다. 다만 **고주파 센싱**이 적절해야 유효성이 커짐

**현 프로젝트 제약과 대안**

- 현재 분석 대역은 **≤150 Hz**. 본격적인 베어링 진단에 필요한 **수 kHz 대역**이 부족.
- 대안으로, **50–150 Hz 밴드**를 **Hilbert 포락**으로 복조한 뒤 **저주파(예: 0.3–50 Hz)에서 피크**를 확인. 이는 **보조 지표**로만 사용하세요(강한 확증 근거로 사용 X).

**스텝 바이 스텝 — 저대역 포락 간이 레시피**

1. 원시 또는 전처리 신호에 **bandpass(50–150 Hz)** 적용.
2. **Hilbert 변환**으로 포락 신호 `env(t)`를 구함.
3. `env(t)`를 다시 **FFT/PSD**로 분석하여 **저주파**의 피크를 본다(1×, 2× 근처 포함).
4. **포락 피크/평균**을 기록(보조 지표).

**체크리스트 / 주의점**

- [ ]  “포락”은 **보조** 지표임을 리포트에 명시(대역 제약)
- [ ]  포락으로 **1×/2× 주변**이 동반 상승하면 회전성 충격 가능성↑

---

## 3.4 가속도(acc)와 자이로(gyro)의 역할: 선형 vs 회전 흔들림, 융합 관찰 포인트

**쉽게 설명**

- **acc(가속도)**: 구조물의 **직선 방향 흔들림**. **진동의 세기**(충격/고주파 포함)에 민감.
- **gyro(자이로)**: **각속도**의 변화, 즉 **회전 흔들림**. **축의 떨림/정렬 문제**에 민감.
- **융합 포인트**: 같은 주파수에서 **acc와 gyro가 동시에 피크**를 보이면 **회전 기인**의 가능성↑. acc만 크면 구조적(고정/장착/공진)일 수도.

**스텝 바이 스텝 — 간단 융합 플래그**

1. acc-Sum의 **상위 피크 주파수** 리스트를 구함(예: 상위 3개).
2. gyro-Z(또는 축과 일치 가능성이 높은 축)의 상위 피크와 **주파수 매칭**(±0.5 Hz 이내).
3. **동시피크 개수**와 **최대피크 일치 여부**를 플래그로 기록: `same_peak_flag ∈ {0,1}`.

**체크리스트 / 주의점**

- [ ]  자이로 채널이 없다면 acc-Sum + 축별 비교로 대체
- [ ]  센서 축 정렬 불확실 → 절대값보다는 **동시피크·비율**을 중시

---

## 3.5 오더 분석 개념: RPM 로그 부재 시의 대안(1× 추정 → 준-오더 정규화)

**쉽게 설명**

- **오더 분석**은 “주파수를 **회전수(1×)**로 나눈 척도(=오더)”로 보는 방법. 속도가 변해도 **1×, 2×, 3×**가 **1, 2, 3**으로 **고정**되어 비교가 쉬움.
- 이번 프로젝트는 **RPM 로그가 없으므로**, 1×를 **추정**하여 “**준-오더**”로 사용하는 방법 필요.

**스텝 바이 스텝 — 1× 추정(준-오더 준비)**

1. **FFT 저주파**에서 가장 강한 후보를 찾음(0.3–50 Hz).
2. *자기상관(autocorr)**로 기본 주기(=1× 역수) 후보를 얻음.
3. **자이로 피크**가 있으면 교차검증.
4. **후보들의 중앙값**을 1×로 채택, **유사성(오차)**로 신뢰도: High(≤0.5 Hz), Med(≤1.0 Hz), Low(>1.0 Hz).
5. 신뢰도가 **Med 이상**일 때만 `오더 = f / f1×`로 정규화한 피처(2×/1× 등)를 사용.

**체크리스트 / 주의점**

- [ ]  1× 신뢰도 **Low** → 오더 피처 **사용 금지**, **Hz 피처만** 사용
- [ ]  2×/1× 비율은 1× 추정이 합리적일 때만 의미가 큼

---

## 3.6 크레스트 팩터(CF=Peak/RMS), 커토시스: 충격성 지표 해석

**쉽게 설명**

- **CF(크레스트 팩터)** = `최대진폭 / RMS` → **순간적인尖峰(충격)**이 많을수록 커짐.
- **커토시스(kurtosis)**: 분포의 **첨도**. 꼬리(극단값)가 두껍고 피크가 날카로우면 커짐 (충격성↑).

**왜 중요한가**

- 베어링/기어 결함 초기에는 **충격성** 신호가 자주 생겨 CF/커토시스가 **상대적으로 상승.**

**스텝 바이 스텝 — 해석 가이드(경험칙)**

1. 파일 내 윈도들의 CF 분포를 보고 **상위 백분위(P90/P95)**를 기록. 
2. PASS 집단의 백분위와 비교하여 **이탈 정도**를 본 뒤 임계(T3)를 **P95 근처**에서 시작해 튜닝.
3. 커토시스도 동일 방식으로 **상대 비교**(절대 임계보다 상대 변화에 주목).

**체크리스트 / 주의점**

- [ ]  단위/스케일이 다른 센서 간 **절대 비교 금지** → **백분위/상대값** 사용
- [ ]  CF는 **스파이크 오류**에도 민감 → **포화/불연속** QC 체크와 함께 해석

---

# 실무 보충: 바로 써먹는 “현장 레시피”

### 레시피 A — “기본 회전성(1×/2×) 있는지 빠르게 보는 법”

1. acc-Sum 스펙트럼에서 0.3–50 Hz에 **뚜렷한 피크**가 있는지 확인.
2. 같은 위치의 **gyro**에도 피크가 있는지 매칭(±0.5 Hz).
3. 그 피크의 **2배** 위치에 보조 피크가 있으면 **정렬/비대칭** 가능성 메모.
4. 리포트: `pmax_f`, `2×/1×`, `same_peak_flag`, `rms_10_50` 기재.

### 레시피 B — “사이드밴드 의심 시”

1. 캐리어(뚜렷한 고정 피크)를 하나 선택.
2. 좌우를 확대해서 **±d(≈1×)** 간격으로 작은 톱니가 반복되는지 눈으로 확인.
3. `SB_index = (좌우 ±d, ±2d 진폭 합) / 캐리어 진폭` 계산·기록.
4. 기어/편심/백래시 의심 코멘트.

### 레시피 C — “포락(보조)로 충격성 감지”

1. 50–150 Hz 밴드패스 → Hilbert 포락 → FFT(0.3–50 Hz).
2. 포락에서 **1×/2×** 근처 피크가 강하면 “회전성 충격” 메모.
3. 리포트에 포락 피크 수치 + 그래프 한 장 첨부(“보조 지표” 명시).

---

# 초보자 체크리스트 (요약)

- [ ]  1×/2×/고조파: **정수배** 패턴인지 먼저 본다.
- [ ]  대역RMS(1–10/10–50/50–150): **어느 구간이 유난히 큰지** 본다.
- [ ]  자이로 동시피크: **회전성** 근거 강화.
- [ ]  사이드밴드: **±1× 간격의 작은 톱니**가 캐리어 주변에 줄지어 있는가?
- [ ]  포락: **보조**로만 사용(대역 제약).
- [ ]  CF/커토시스: **상위 백분위**를 PASS 기준과 비교(절대치보다 상대 변화).
- [ ]  1× 신뢰 Low면 **오더 피처 사용 금지**, Hz 피처만.

---

# 참고 수식/파라미터 메모 (요약 카드)

- 샘플링: `fs ≈ 1000 / median(Δt_ms)`
- FFT/PSD: Hann, nperseg=1024, noverlap=512 → Δf≈`fs/nperseg`≈0.5 Hz
- 대역RMS: `RMS_band = sqrt(mean(x_band^2))`
- CF: `peak / RMS`
- 포락: `env = |hilbert(bandpass(x, 50–150 Hz))|` → `FFT(env)`
- 오더: `order = f / f1×(추정)` (conf ∈ {High, Med}일 때만)

# 4. 핵심 과제/이슈 정의 및 해결 전략

## 4.1 정상 희소/불균형 레이블 대응

### 4.1.1 레이블 맵(PASS=정상+소음, FAIL=진동+표기없음)과 대안(3클래스 후 병합)

**설명**

- 관능 결과는 {정상, 소음, 진동, 표기없음}. 운영 목적은 **양불 이원분류**이므로,
    - **PASS** = 정상 + 소음
    - **FAIL** = 진동 + 표기없음
        
        로 맵핑합니다.
        
- 대안: **3클래스(정상/소음/불량)로 학습** 후, 운영에서 정상+소음을 **PASS로 병합**하는 방법도 있음. (라벨 잡음이 크거나 “소음”이 많을 때 고려).

**왜 중요한가**

- “정상” 표본이 매우 적어 **클래스 불균형**이 큼. 단순 이원분류에선 정상 패턴 학습이 어려울 수 있음.
- “소음”은 경계 사례여서, PASS로 치되 **강하게 확정**하지 않도록 설계해야 함.

**스텝 바이 스텝**

1. **이원분류 기본안**으로 먼저 구축(PASS=정상+소음, FAIL=진동+표기없음).
2. 베이스라인 성능이 불안정하면 **3클래스 모델**을 추가 실험: (정상/소음/불량).
3. 3클래스 모델을 사용할 때는 **운영 시** 확률(`p(정상)+p(소음)`)로 PASS 판단.

**체크리스트**

- [ ]  `label_bin`(0/1), `label_tri`(정상/소음/불량) 동시에 보유(실험 편의)
- [ ]  운영은 **이원분류**로 귀결(판정 단순화)
- [ ]  3클래스는 “분류 경계 의미”를 이해할 현장 여건이 있을 때만 채택

**샘플(파이썬 개념 코드)**

```python
label_map_bin = {"정상":1, "소음":1, "진동":0, "표기없음":0}
label_map_tri = {"정상":2, "소음":1, "진동":0, "표기없음":0}  # 예: 불량=0/소음=1/정상=2

```

---

### 4.1.2 소음의 약한 양성(weak positive) 가중치/스무딩 전략

**쉽게 설명**

- “소음”은 PASS이지만 **경계**에 있는 표본. 학습에서 **너무 자신 있게 PASS**로 가르치면 미세 이상을 놓칠 수 있음.

**왜 중요한가**

- 경계 라벨을 1.0로 강제하면 **결정 경계가 과도하게 완만**해져 오탐/미탐 균형이 깨질 수 있음.

**스텝 바이 스텝**

1. **샘플 가중치**: “소음” 표본의 `weight=0.5`(기타=1.0).
2. **타깃 스무딩**: 이원분류에서 PASS=1.0 대신 **0.8**로 부드럽게(학습만, 평가엔 0/1).
3. 둘 중 하나만 적용해도 충분. 성능에 따라 함께 적용도 가능(우선은 가중치 → 필요 시 스무딩 추가).

**체크리스트**

- [ ]  `weight` 컬럼: 소음=0.5, 그 외=1.0
- [ ]  `y_bin_smooth`: 소음의 PASS=0.8(평가 시 미사용)
- [ ]  설정은 YAML로 고정(재현성)

**샘플(YAML)**

```yaml
labels:
  weak_positive_weight_for_소음: 0.5
  smoothing_for_소음: 0.8

```

---

### 4.1.3 증강: 윈도 분할/중첩, 시간 시프트, 저강도 노이즈

**쉽게 설명**

- 한 파일을 **8초 윈도(50% 중첩)**로 쪼개 표본 수를 늘림.
- 시간축을 약간 **순환 시프트**하거나, 미세 **노이즈**(SNR 30~40 dB)를 추가해 **과적합을 완화.**

**왜 중요한가**

- 불균형·소표본에서 **표본 다양성**을 확보해야 일반화가 좋아짐.

**스텝 바이 스텝**

1. **윈도화**: win=8 s, hop=4 s. tail<8 s는 제외.
2. **시프트**: 윈도 내에서 ±5~10% 순환 이동(주파수 성분 동일).
3. **노이즈**: 작은 가우시안 노이즈 추가(SNR 30~40 dB).
4. **스케일**: ±3% 진폭 스케일(센서 감도 편차 범위).

**금지/주의**

- **타임워프/속도 변경 금지**(1×/2× 자체가 변형됨).
- **증강은 훈련 세트에서만 적용.**

---

## 4.2 CW/CCW 방향성

### 4.2.1 별도 인스턴스 처리 + 방향 피처

**설명**

- 같은 시료라도 CW/CCW가 다른 특성 보일 수 있음.
- **파일/윈도 단위**에선 **별도 인스턴스**로 처리하고, `direction∈{CW,CCW}`를 **범주형 메타 피처**로 포함시킴.

**왜 중요한가**

- 방향 비대칭이 실제 결함 징후일 수 있음. 모델이 그 차이를 **학습**하도록 힌트를 주는 셈임.

**스텝 바이 스텝**

1. 파서에서 `direction`을 추출(CW=+1, CCW=-1 또는 one-hot).
2. EDA/데이터셋에 `direction` 컬럼 포함(모델 입력에 넣거나, 분리 모델 실험).
3. **GroupKFold**에서는 (product, sample)로 **같은 시료의 CW/CCW를 같은 폴드**에 묶음(누수 방지).

**체크리스트**

- [ ]  입력 테이블에 `direction` 존재
- [ ]  모델 입력에 넣되, 과적합 유무를 모니터링(피처 중요도 확인)

---

### 4.2.2 시료 단위 최종 판정의 집계 룰(max/보수적 OR)

**설명**

- 윈도 확률 → 파일 확률(파일 내 **max**) → 시료 확률(**CW/CCW 중 max**).
- **보수적 OR**: 한 방향이라도 FAIL이면 **시료 FAIL**.

**왜 중요한가**

- 어느 방향에서든 이상이 나면 **부품 수준 위험**으로 간주하는 보수적 QC 정책을 반영.

**스텝 바이 스텝**

1. 윈도 확률 리스트 → `file_prob = max(window_prob)`
2. 시료에서 두 파일(CW, CCW) 존재 → `sample_prob = max(file_prob_CW, file_prob_CCW)`
3. **룰-OR**: (모델 확률≥τ) **OR** (룰 히트)로 파일 FAIL → 시료 FAIL로 승격.

**체크리스트**

- [ ]  집계 함수와 승격 규칙을 문서화(운영 문서)
- [ ]  max 대신 **상위 q%**(예: 90th)도 실험해 FP 안정화 검토

---

## 4.3 RPM 로그 부재

### 4.3.1 1× 추정(FFT+자기상관+자이로 크로스체크)

**설명**

- RPM이 없으므로 1×를 **신호에서 추정하는 방법 활용** (저주파 FFT 피크 + 자기상관 + 자이로 일치).

**스텝 바이 스텝(요약)**

1. **FFT 저주파**(0.3–50 Hz)에서 가장 큰 피크 `f_fft`
2. **자기상관**으로 기본 주기 `T0` → `f_ac = 1/T0`
3. **자이로**에서 동일 대역 피크 `f_g`(있다면)
4. 후보들의 중앙값 `f1x = median({f_fft,f_ac,f_g})`
5. 평균 절대 오차로 **신뢰도**: High(≤0.5 Hz), Med(≤1.0 Hz), Low(>1.0 Hz)

**체크리스트**

- [ ]  `f1x`, `f1x_conf` 컬럼 저장
- [ ]  신뢰도 Low면 **오더 피처 제외**, Hz 피처만 사용

---

### 4.3.2 오더 정규화(주파수→오더, 대역→오더 대역)

**쉽게 설명**

- `오더 = f / f1x`. 속도가 바뀌어도 1×, 2×, 3×는 각각 1, 2, 3에 정렬됩니다.
- 대역도 오더 축으로 변환 가능(예: 1–3 오더 대역 에너지).

**스텝 바이 스텝**

1. `f1x_conf ∈ {High, Med}`인 윈도만 오더 피처 계산.
2. 피크 주파수 리스트를 오더로 변환: `order = f / f1x`.
3. 오더 대역 에너지: 예를 들어 **1–3 오더**, **3–6 오더** 등으로 RMS 계산.
4. **2×/1× 비율**은 오더에서 **2/1** 피크 비율과 동일해 해석이 쉬움.

**체크리스트**

- [ ]  오더 피처 사용 범위 명확화(신뢰도 조건)
- [ ]  보고서에는 Hz/오더를 **병기**(해석 도움)

---

## 4.4 제품군(100/200) 차이

### 4.4.1 통합모델 + 제품 one-hot → 분리모델 병행 검토

**쉽게 설명**

- 먼저 **통합모델**에 `product∈{100W,200W}`를 **one-hot**으로 넣어 학습
- 이후, **제품별 모델(2개)** 또는 **제품×방향(4개)** 분리 모델과 성능 비교

**왜 중요한가**

- 제품 구조/감속비/강성 차로 신호 분포가 달 수 있음. 분리 모델이 성능을 올릴 때가 있음.

**스텝 바이 스텝**

1. 통합모델(base) 학습 → Valid/Test 성능 확보
2. **100/200 분리** 두 모델 학습 → 성능 비교
3. 필요 시 **100/200 × CW/CCW** 네 모델 학습 → 성능·운영 복잡도 비교
4. 개선폭(예: Recall +3%p 이상, Precision 손실 ≤2%p)이면 **분리 채택** 검토

**체크리스트**

- [ ]  분리 모델 수가 늘면 **버전/운영 복잡도**가 증가 → 관리 가능성 평가
- [ ]  통합 대비 개선폭이 작으면 **통합 유지**(운영 단순)

---

### 4.4.2 정규화/오더 기반 비교로 제품 차 흡수

**쉽게 설명**

- 단위/스케일 차이를 **상대 지표**(비율/백분위)와 **오더 정규화**로 흡수.

**스텝 바이 스텝**

1. 모든 **절대치**(예: RMS, peak)는 **제품별 표준화** 또는 **백분위 스케일**로 병기.
2. **주파수 특성**은 가능하면 **오더**로 비교(1× 신뢰도 조건).
3. 리포트에 “제품 보정/병기”를 명시(근거 투명성).

**체크리스트**

- [ ]  Hz/오더 병기
- [ ]  제품별 분포 편차(PSI) 모니터링

---

## 4.5 포락/사이드밴드 적용성

### 4.5.1 현 샘플링(≤150 Hz) 제약 하에서의 대안

**쉽게 설명**

- 진짜 베어링 특화 포락은 **수 kHz**가 유리. 현재는 ≤150 Hz 제약으로 **간이 포락**만 사용 가능.
- 기어의 GMF도 대역 밖일 가능성이 커서 **사이드밴드 패턴(±1× 간격)**을 **대안 단서**로 삼음 .

**스텝 바이 스텝(대안 운영)**

1. **간이 포락**: 50–150 Hz 밴드 → Hilbert → 0.3–50 Hz FFT, **보조 지표**로 기록.
2. **사이드밴드 지표**: 캐리어 주변 ±1×, ±2× 진폭 합 / 캐리어 진폭 → 기록.
3. 모델 입력에는 **보수적으로** 사용(과신 금지), 리포트에 “제약 하 보조” 표기.

**체크리스트**

- [ ]  포락/사이드밴드 지표는 **경계 PASS 선별**에 유용(보루 역할)
- [ ]  본 판정은 **CF/대역RMS/2×/1×** 등 안정 지표에 우선권

---

### 4.5.2 후속 과제(고주파 센싱)

**핵심 제언**

- **고주파 가속도 센서(≥5 kHz 샘플링)** 추가 라인 도입 시:
    - 진짜 **베어링 포락(수 kHz 캐리어)** 가능
    - 기어 **GMF 직접 검출** 및 **사이드밴드 정량** 향상
    - **코히어런스/위상** 기반 회전성 vs 구조성 분리 개선

**우선순위**

1. 현 체계 안정화(이원판정 + 하이브리드 룰)
2. 샘플 일부에 **고주파 센서 병행 측정**(파일럿)
3. 포락·사이드밴드 확장 피처군 설계 및 비교 리포트

---

## 종합 체크리스트(실행 순서 요약)

1. **라벨 맵 확정**: PASS=정상+소음, FAIL=진동+표기없음(+ 소음 가중/스무딩)
2. **윈도화·증강**: 8 s/50% 중첩, 순환 시프트·저강도 노이즈·±3% 스케일
3. **방향 처리**: CW/CCW 별도 인스턴스 + 방향 피처, 시료 집계는 **max/보수적 OR**
4. **1× 추정 & 오더**: FFT+AC+gyro, 신뢰도 High/Med에서만 오더 사용
5. **제품 차 흡수**: 통합모델+one-hot → 분리모델 비교, Hz/오더 병기
6. **포락/사이드밴드**: 제약하 보조 지표로 사용(리포트 명시)
7. **문서화**: YAML 설정·임계·룰·집계 규칙을 고정, 의사결정 로그 자동 저장

---

## 부록: 설정 예시(발췌)

```yaml
labels:
  binary_map: { PASS: ["정상","소음"], FAIL: ["진동","표기없음"] }
  weak_positive_weight_for_소음: 0.5
  smoothing_for_소음: 0.8

windowing:
  win_len_s: 8.0
  overlap: 0.5
augmentation:
  time_shift_frac: 0.1      # ±10% 이내 순환 시프트
  noise_snr_db: 35          # 30~40 dB
  amplitude_scale_pct: 3    # ±3%

order:
  f1_search_max: 50.0
  conf_high_tol_hz: 0.5
  conf_med_tol_hz: 1.0

aggregation:
  window_to_file: max
  cw_ccw_to_sample: max     # 보수적 OR

```