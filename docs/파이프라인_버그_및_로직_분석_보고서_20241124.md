# íŒŒì´í”„ë¼ì¸ ë²„ê·¸ ë° ë¡œì§ ë¶„ì„ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2025-11-24
**ëª©ì **: ì „ì²´ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ë²„ê·¸ ì‹ë³„ ë° ë¶„ì„ ëª©ì ê³¼ ì‹¤ì œ êµ¬í˜„ ê°„ ë¶ˆì¼ì¹˜ ê²€ì¦

---

## Executive Summary

### ì£¼ìš” ë°œê²¬ì‚¬í•­

1. **ğŸ”´ CRITICAL: ì˜ë„í•˜ì§€ ì•Šì€ Oversampling ìˆ˜í–‰**
   - ë³´ê³ ì„œ: "Oversampling ë¯¸ì‚¬ìš©"
   - ì‹¤ì œ: `params_eda.yaml`ì—ì„œ `method: "oversample"` í™œì„±í™”
   - ê²°ê³¼: Train Normal ë°ì´í„°ê°€ ë³µì œë˜ì–´ window_id ì¤‘ë³µ ë°œìƒ

2. **ğŸ”´ CRITICAL: window_id ì¤‘ë³µ ìƒì„±**
   - 684 rows â†’ 612 unique window_ids (72ê°œ ì¤‘ë³µ)
   - Oversampling ì‹œ `replace=True`ë¡œ ì¸í•œ ì¤‘ë³µ
   - `ignore_index=True`ë¡œ ì¸í•´ ì›ë³¸ ì¸ë±ìŠ¤ ì†ì‹¤

3. **ğŸŸ¡ IMPORTANT: ë°ì´í„° êµ¬ì¡° ë¬¸ì„œì™€ ì‹¤ì œ ë¶ˆì¼ì¹˜**
   - ë³´ê³ ì„œ: 898 windows (Train 695)
   - ì‹ ê·œ ì‹¤í–‰: 684 windows (Train 481)
   - 214ê°œ ìœˆë„ìš° ì°¨ì´ ì›ì¸ ë¯¸ìƒ

4. **ğŸŸ¢ MINOR: Normal íŒŒì¼ ì‹ë³„ ë¶ˆì¼ì¹˜**
   - `params_eda.yaml`: Normalì€ Sample00ë§Œ (100W), Sample03ë§Œ (200W)
   - ë³´ê³ ì„œ: Normal 11ê°œ íŒŒì¼ (S00, S01, S05, S06, S03)
   - ì‹¤ì œ íŒŒì¼: Sample01 ì¡´ì¬ í™•ì¸

---

## 1. Oversampling ë²„ê·¸ ìƒì„¸ ë¶„ì„

### 1.1 ë¬¸ì„œì™€ ì½”ë“œ ë¶ˆì¼ì¹˜

**í”„ë¡œì íŠ¸_ì¢…í•©_ë¶„ì„_ë³´ê³ ì„œ.md (Line 164-167)**:
```markdown
**í´ë˜ìŠ¤ ê· í˜• ë°©ë²•**:
- **Oversampling ë¯¸ì‚¬ìš©**: ëª¨ë“  ìœˆë„ìš°ëŠ” ì›ë³¸ ë°ì´í„°ì—ì„œ ìƒì„±
- **XGBoost scale_pos_weight**: íŒŒë¼ë¯¸í„°ë¡œ í´ë˜ìŠ¤ ê°€ì¤‘ì¹˜ ì¡°ì • (0.879)
- Normal 10ê°œ íŒŒì¼, Abnormal 56ê°œ íŒŒì¼ â†’ ìì—°ìŠ¤ëŸ¬ìš´ í´ë˜ìŠ¤ ë¶ˆê· í˜•
```

**ì‹¤ì œ ì½”ë“œ (src/config/params_eda.yaml Line 120-133)**:
```yaml
balancing:
  apply_to_train_only: true
  target_ratio:
    normal: 1
    abnormal: 2  # ì •ìƒ:ë¶ˆëŸ‰ = 1:2
  method: "oversample"  # â† í™œì„±í™”ë¨!
  random_seed: 42
```

**ì‹¤ì œ êµ¬í˜„ (src/preprocess/balance.py Line 132-136)**:
```python
if n_normal_target > n_normal:
    # Oversample
    normal_resampled = normal_windows.sample(
        n=n_normal_target,
        replace=True,  # â† ì¤‘ë³µ í—ˆìš©!
        random_state=random_seed
    )
```

### 1.2 ë²„ê·¸ ì˜í–¥ ë¶„ì„

**í˜„ìƒ**:
```python
# run_pipeline.py ì‹¤í–‰ ê²°ê³¼
windows_balanced_v1.parquet: 684 rows
features_combined_v1.parquet: 684 rows
  â†’ Unique window_ids: 612ê°œ
  â†’ ì¤‘ë³µ: 72ê°œ (684 - 612)
```

**ì›ì¸ ìˆœì„œ**:
1. `create_windows_metadata()`: 650ê°œ ìœˆë„ìš° ìƒì„± (ì¤‘ë³µ ì—†ìŒ)
2. `balance_train_windows()`: Train Normal ì˜¤ë²„ìƒ˜í”Œë§
   - Original Train Normal: 160ê°œ
   - Target: 160 Ã— 2 = 320ê°œ (ratio 1:2 ë‹¬ì„± ìœ„í•´)
   - Oversampling: 160ê°œ ì¶”ê°€ ë³µì œ â†’ **160ê°œ window_id ì¤‘ë³µ ìƒì„±**
3. **í•˜ì§€ë§Œ ì‹¤ì œ ë¡œê·¸**: Train 481 (Normal 160, Abnormal 321)
   - Normalì´ ì˜¤ë²„ìƒ˜í”Œë§ë˜ì§€ ì•ŠìŒ?
   - **ëª¨ìˆœ**: ì„¤ì •ì€ oversampleì´ì§€ë§Œ ì‹¤í–‰ì€ undersampleì²˜ëŸ¼ ë™ì‘

**ê²€ì¦ í•„ìš”**:
```bash
# ì‹¤ì œ balancing ë™ì‘ í™•ì¸
python -c "
import pandas as pd
windows = pd.read_parquet('data/processed/windows_balanced_v1.parquet')
train = windows[windows['split_set'] == 'train']
print(f'Train: {len(train)}')
print(f'Normal: {(train[\"label_binary\"]==1).sum()}')
print(f'Abnormal: {(train[\"label_binary\"]==0).sum()}')
print(f'Unique window_ids: {train[\"window_id\"].nunique()}')
print(f'Duplicates: {train[\"window_id\"].duplicated().sum()}')
"
```

### 1.3 ê·¼ë³¸ ì›ì¸

**ë¬¸ì œ 1: ì˜ëª»ëœ ì„¤ê³„**
- `pandas.sample(replace=True)`ëŠ” **ë™ì¼í•œ í–‰ì„ ë³µì œ**
- ë³µì œëœ í–‰ì€ **ë™ì¼í•œ window_id ìœ ì§€**
- `ignore_index=True`ë¡œ ì¸í•´ ì›ë³¸ DataFrame ì¸ë±ìŠ¤ ì†ì‹¤
- ê²°ê³¼: **ì¤‘ë³µ window_idê°€ ë°ì´í„°ì…‹ì— í¬í•¨**

**ë¬¸ì œ 2: ë¬¸ì„œì™€ êµ¬í˜„ ë¶ˆì¼ì¹˜**
- ë³´ê³ ì„œëŠ” "Oversampling ë¯¸ì‚¬ìš©"ì´ë¼ê³  ëª…ì‹œ
- ì‹¤ì œ ì½”ë“œëŠ” oversampling í™œì„±í™”
- í”„ë¡œì íŠ¸ ì˜ë„ì™€ ì‹¤ì œ êµ¬í˜„ì´ ë‹¤ë¦„

**ë¬¸ì œ 3: ê²€ì¦ ë¶€ì¬**
- `balance_train_windows()` í›„ window_id uniqueness ì²´í¬ ì—†ìŒ
- Downstream ì½”ë“œ(step3_3, Phase3)ì—ì„œë„ ì¤‘ë³µ ê²€ì¦ ì—†ìŒ

---

## 2. Window ID ì¤‘ë³µ ë¬¸ì œ

### 2.1 ì¤‘ë³µ ë°œìƒ ë©”ì»¤ë‹ˆì¦˜

```python
# src/preprocess/balance.py Line 166-169
balanced_train = pd.concat([normal_resampled, abnormal_resampled], ignore_index=True)
# â†‘ ignore_index=True: ì›ë³¸ ì¸ë±ìŠ¤ ë²„ë¦¼, ìƒˆ ì¸ë±ìŠ¤ 0,1,2,... ìƒì„±
# â†“ í•˜ì§€ë§Œ window_id ì»¬ëŸ¼ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ â†’ ì¤‘ë³µ!

balanced_train = balanced_train.sample(frac=1, random_state=random_seed).reset_index(drop=True)
# â†‘ ì…”í”Œë§ìœ¼ë¡œ ì¤‘ë³µ window_idê°€ ë¬´ì‘ìœ„ë¡œ ì„ì„
```

**ì˜ˆì‹œ**:
```
ì›ë³¸ Train Normal (160 windows):
  window_id: [W0001, W0002, ..., W0160]

Oversample to 320:
  normal_resampled = sample(n=320, replace=True)
  â†’ window_id: [W0001, W0001, W0005, W0002, W0002, ..., W0160, W0003, ...]
                ^^^^^^ ^^^^^^ ì¤‘ë³µ!

ê²°ê³¼:
  612 unique window_idsê°€ 684 rowsë¡œ í™•ì¥
  72ê°œ ì¤‘ë³µ (ëŒ€ë¶€ë¶„ Normal ìœˆë„ìš°)
```

### 2.2 Downstream ì˜í–¥

**step3_3_add_band_rms.py (Line 311)**:
```python
features_enhanced = features_df.merge(band_rms_df, on='window_id', how='left')
```

**ì˜ˆìƒ ë™ì‘**:
- features_df: 684 rows (612 unique window_ids + 72 duplicates)
- band_rms_df: 684 rows (windows_df ê¸°ë°˜ìœ¼ë¡œ ìƒì„±, ë™ì¼ ì¤‘ë³µ íŒ¨í„´)
- Merge: 684 rows ì˜ˆìƒ

**ì‹¤ì œ ë™ì‘**:
- ê²°ê³¼: 898 rows (!!)
- ì›ì¸: **features_dfê°€ 684ê°€ ì•„ë‹Œ 898 rowsì˜€ìŒ**

**ì¶”ê°€ ê²€ì¦ í•„ìš”**:
- features_combined_v1.parquetê°€ ì‹¤ì œë¡œ run_pipeline.pyì—ì„œ ìƒì„±ë˜ì—ˆëŠ”ê°€?
- ì•„ë‹ˆë©´ ê¸°ì¡´ 898 rows íŒŒì¼ì´ ë®ì–´ì“°ê¸° ì‹¤íŒ¨ë¡œ ìœ ì§€ë˜ì—ˆëŠ”ê°€?

---

## 3. ë°ì´í„° íŒŒì¼ ìˆ˜ ë¶ˆì¼ì¹˜

### 3.1 Normal íŒŒì¼ ì‹ë³„ ë¬¸ì œ

**params_eda.yaml (Line 10-12)**:
```yaml
normal_samples:
  "100W": [0]      # Sample00ë§Œ
  "200W": [3]      # Sample03ë§Œ
```

**í”„ë¡œì íŠ¸_ì¢…í•©_ë¶„ì„_ë³´ê³ ì„œ.md (Line 71-73)**:
```markdown
- **Normal: 11ê°œ íŒŒì¼**
  - 100W: S00(CCW,CW), S01(CCW,CW), S05(CCW,CW), S06(CCW,CW) = 8ê°œ
  - 200W: S02(CW), S03(CCW,CW) = 3ê°œ
```

**ì‹¤ì œ ë°ì´í„° í™•ì¸**:
```bash
ls data/100W/*Sample0[0156]*.csv
# S00, S01 ì¡´ì¬ í™•ì¸ (S05, S06ì€ í™•ì¸ í•„ìš”)

ls data/200W/*Sample0[23]*.csv
# S02, S03 ì¡´ì¬ í™•ì¸
```

**ëª¨ìˆœ**:
- `params_eda.yaml`: Sample00, Sample03ë§Œ Normal
- ë³´ê³ ì„œ: Sample00~06 ì¤‘ ì¼ë¶€ê°€ Normal
- ì‹¤ì œ: Sample00, Sample01 ì¡´ì¬

**ê°€ëŠ¥ì„±**:
1. í”„ë¡œì íŠ¸ ì§„í–‰ ì¤‘ Normal ì •ì˜ ë³€ê²½
2. `params_eda.yaml`ì´ ìµœì‹  ìƒíƒœê°€ ì•„ë‹˜
3. ë³´ê³ ì„œ ì‘ì„± ì‹œ ë‹¤ë¥¸ ê¸°ì¤€ ì ìš©

### 3.2 íŒŒì¼ ìˆ˜ ì°¨ì´

**ë³´ê³ ì„œ (Phase3 ê¸°ì¤€)**:
- ì›ë³¸: 61ê°œ CSV
- ì‚¬ìš©: 57ê°œ (í’ˆì§ˆ ë¯¸ë‹¬ 4ê°œ ì œì™¸)
- Normal: 11ê°œ (4ê°œ time_split + 7ê°œ file_split?)
- Abnormal: 46ê°œ

**í˜„ì¬ ì‹¤í–‰ (2025-11-24)**:
- ì›ë³¸: 61ê°œ CSV
- ë¡œë“œ: 60ê°œ (run_pipeline.py ì¶œë ¥)
- ì‚¬ìš©: 57ê°œ (quality check í›„)
- Normal: 4ê°œ? (params_eda.yaml ê¸°ì¤€)

**ì§ˆë¬¸**:
1. Normal 11ê°œëŠ” ì–´ë””ì„œ ë‚˜ì™”ëŠ”ê°€?
2. ë³´ê³ ì„œì˜ 898 windowsëŠ” ì–´ë–»ê²Œ ìƒì„±ë˜ì—ˆëŠ”ê°€?
3. í˜„ì¬ 684 windowsì™€ 214ê°œ ì°¨ì´ëŠ” ë¬´ì—‡ì¸ê°€?

---

## 4. ìœˆë„ìš° ìƒì„± ë¡œì§ ê²€ì¦

### 4.1 ì„¤ê³„ ì˜ë„ (ë³´ê³ ì„œ ê¸°ì¤€)

```markdown
ìœˆë„ìš° ë¶„í•  ë°©ë²•:
- ìœˆë„ìš° í¬ê¸°: 8ì´ˆ (4096 ìƒ˜í”Œ @ 512 Hz)
- ì˜¤ë²„ë©: 50% (4ì´ˆ ê²¹ì¹¨)
- ëª©ì : ì‹œê³„ì—´ì˜ êµ­ì†Œì  íŒ¨í„´ í¬ì°© ë° ìƒ˜í”Œ ìˆ˜ í™•ë³´

ìµœì¢… ìœˆë„ìš°: 898ê°œ (Normal: 392ê°œ, Abnormal: 506ê°œ)
```

### 4.2 ì‹¤ì œ êµ¬í˜„ (src/preprocess/segment.py)

**íŒŒë¼ë¯¸í„° (params_eda.yaml Line 103-115)**:
```yaml
windowing:
  window_sec: 8.0       # 8ì´ˆ ìœˆë„ìš°
  hop_sec: 4.0          # 4ì´ˆ hop (50% ì¤‘ì²©)
  stable_margin: 0.1    # ì•/ë’¤ 10% ì œì™¸
  max_windows_per_file: 200
  boundary_handling: "strict"  # ê²½ê³„ ë„˜ëŠ” ìœˆë„ìš° ë²„ë¦¼
```

**ë¡œì§ (segment.py Line 80-133)**:
```python
# 1. ì•ˆì • êµ¬ê°„ ì¶”ì¶œ (ì•/ë’¤ 10% ì œì™¸)
start_margin = total_duration * stable_margin
end_margin = total_duration * (1 - stable_margin)

# 2. ì‹œê°„ ê¸°ë°˜ ë¶„í•  (Normal íŒŒì¼ë§Œ)
if split_set == 'time_split':
    for range_name, (t_start_frac, t_end_frac) in time_ranges.items():
        range_start = start_margin + (end_margin - start_margin) * t_start_frac
        range_end = start_margin + (end_margin - start_margin) * t_end_frac
        # Train: 0-60%, Val: 60-80%, Test: 80-100%

# 3. ìœˆë„ìš° ìŠ¬ë¼ì´ë”©
cur_t = range_start
while cur_t + window_sec <= range_end:
    window_end = cur_t + window_sec
    # 8ì´ˆ ìœˆë„ìš° ì¶”ì¶œ
    cur_t += hop_sec  # 4ì´ˆì”© ì´ë™ (50% ì˜¤ë²„ë©)

# 4. ìµœëŒ€ ìœˆë„ìš° ì œí•œ
if len(windows) > max_windows:
    random.shuffle(windows)
    windows = windows[:max_windows]
```

**ê²€ì¦ í¬ì¸íŠ¸**:
- âœ… 8ì´ˆ ìœˆë„ìš°, 4ì´ˆ hop: ì •ìƒ
- âœ… 50% ì˜¤ë²„ë©: ì •ìƒ
- âœ… ì•ˆì • êµ¬ê°„ ì¶”ì¶œ (ì•/ë’¤ 10% ì œì™¸): ì •ìƒ
- âœ… Strict boundary handling: ì •ìƒ
- âš ï¸ max_windows_per_file=200: ì œí•œ ì ìš© ì—¬ë¶€ í™•ì¸ í•„ìš”
- âš ï¸ time_split ë¡œì§: Train 0-60%, Val 60-80%, Test 80-100% ì •í™•ì„± ê²€ì¦ í•„ìš”

### 4.3 898 vs 684 Windows ì°¨ì´ ì›ì¸

**ê°€ì„¤ 1: Normal íŒŒì¼ ìˆ˜ ì°¨ì´**
- ë³´ê³ ì„œ: Normal 11ê°œ íŒŒì¼ â†’ ë” ë§ì€ Normal windows
- í˜„ì¬: Normal 4ê°œ íŒŒì¼ (params_eda.yaml ê¸°ì¤€) â†’ ì ì€ Normal windows

**ê°€ì„¤ 2: íŒŒì¼ ê¸¸ì´ ì°¨ì´**
- ì›ë³¸ 898: íŠ¹ì • íŒŒì¼ì´ ë” ê¸¸ì—ˆì„ ê°€ëŠ¥ì„±
- í˜„ì¬ 684: ë™ì¼ íŒŒì¼ì´ì§€ë§Œ í’ˆì§ˆ ê²€ì¦ì—ì„œ ì¼ë¶€ êµ¬ê°„ ì œì™¸?

**ê°€ì„¤ 3: max_windows_per_file ì œí•œ**
- 200ê°œ ì œí•œì´ ì¼ë¶€ íŒŒì¼ì— ì ìš©ë˜ì–´ ìœˆë„ìš° ìˆ˜ ê°ì†Œ?

**ê²€ì¦ ë°©ë²•**:
```python
# file_master ë¹„êµ
old_parquet = pd.read_parquet('ê¸°ì¡´_898_ì‹œì _file_master.parquet')
new_parquet = pd.read_parquet('data/interim/file_master_v1.parquet')

print("Old normal files:", old_parquet[old_parquet['is_normal']==True]['file_id'].tolist())
print("New normal files:", new_parquet[new_parquet['is_normal']==True]['file_id'].tolist())
```

---

## 5. Feature ì¶”ì¶œ ë¡œì§ ê²€ì¦

### 5.1 ê¸°ë³¸ íŠ¹ì„± ì¶”ì¶œ (9ê°œ)

**ë³´ê³ ì„œ ëª…ì„¸**:
```python
features = {
    'RMS': ['acc_Y_rms', 'acc_Sum_rms', 'Gyro_Y_rms'],
    'Peak': ['acc_Y_peak', 'acc_Sum_peak', 'Gyro_Y_peak'],
    'Crest Factor': ['acc_Y_crest', 'acc_Sum_crest', 'Gyro_Y_crest']
}
# ì´ 9ê°œ
```

**ì‹¤ì œ êµ¬í˜„ í™•ì¸ í•„ìš”**:
- `src/features/time_domain.py` ê²€ì¦
- RMS, Peak, Crest Factor ê³„ì‚° ë¡œì§ ì •í™•ì„±
- KurtosisëŠ” ë³´ê³ ì„œì— ìˆì§€ë§Œ ìœ„ ë¦¬ìŠ¤íŠ¸ì—ëŠ” ì—†ìŒ (ë¶ˆì¼ì¹˜)

### 5.2 Band RMS íŠ¹ì„± (9ê°œ or 3ê°œ?)

**ë³´ê³ ì„œ (Phase2 Step 3-3)**:
```python
# 9ê°œ Band RMS:
channels = ['acc_Y', 'acc_Sum', 'Gyro_Y']  # 3ê°œ
bands = ['low', 'mid', 'high']  # 3ê°œ
# 3 Ã— 3 = 9ê°œ
```

**Phase3-1 ìµœì¢… ëª¨ë¸**:
```python
# 3ê°œ Core Band RMS:
['acc_Y_rms_high', 'Gyro_Y_rms_high', 'Gyro_Y_rms_low']
# ë‚˜ë¨¸ì§€ 6ê°œëŠ” ì œê±° (ê³¼ì í•© ë°©ì§€)
```

**ì‹¤ì œ êµ¬í˜„ (scripts/step3_3_add_band_rms.py)**:
- Butterworth 4ì°¨ bandpass filter
- ëŒ€ì—­: Low (1-10 Hz), Mid (10-50 Hz), High (50-150 Hz)
- ìƒ˜í”Œë§ ë ˆì´íŠ¸: 512 Hz
- âœ… ë¡œì§ ì •ìƒìœ¼ë¡œ ì¶”ì • (ìì„¸í•œ ê²€ì¦ í•„ìš”)

---

## 6. ì¢…í•© ë²„ê·¸ ë¦¬ìŠ¤íŠ¸

### 6.1 Critical (ì¦‰ì‹œ ìˆ˜ì • í•„ìš”)

| ID | ë²„ê·¸ | ì˜í–¥ | ê·¼ë³¸ ì›ì¸ |
|----|------|------|-----------|
| **BUG-001** | Oversampling ì˜ë„ ìœ„ë°˜ | window_id ì¤‘ë³µ 72ê°œ ìƒì„± | `params_eda.yaml` method: "oversample" í™œì„±í™” |
| **BUG-002** | window_id ì¤‘ë³µ ë¯¸ê²€ì¦ | Downstream merge ì‹œ ë°ì´í„° ì™œê³¡ | `balance.py`ì—ì„œ uniqueness ê²€ì¦ ë¶€ì¬ |
| **BUG-003** | ë¬¸ì„œì™€ ì½”ë“œ ë¶ˆì¼ì¹˜ | ì¬í˜„ì„± ë¶ˆê°€, ì‹ ë¢°ë„ ì €í•˜ | ë¬¸ì„œê°€ ì‹¤ì œ ì½”ë“œ ë°˜ì˜ ì•ˆí•¨ |

### 6.2 Important (ì¡°ì‚¬ ë° ìˆ˜ì • í•„ìš”)

| ID | ì´ìŠˆ | ì˜í–¥ | ì¡°ì‚¬ í•„ìš” ì‚¬í•­ |
|----|------|------|---------------|
| **ISSUE-001** | 898 vs 684 windows ì°¨ì´ | ëª¨ë¸ ì„±ëŠ¥ ì°¨ì´ ê°€ëŠ¥ì„± | Normal íŒŒì¼ ì •ì˜ ë³€ê²½ ì´ë ¥ í™•ì¸ |
| **ISSUE-002** | Normal íŒŒì¼ ì‹ë³„ ê¸°ì¤€ ë¶ˆì¼ì¹˜ | ë°ì´í„° ë¶„í•  ì „ëµ í˜¼ë€ | 11ê°œ vs 4ê°œ Normal íŒŒì¼ ê·¼ê±° ëª…í™•í™” |
| **ISSUE-003** | features_v2 898 rows ìƒì„± | ì‹¤ì œ ë°ì´í„° ì†ŒìŠ¤ ë¶ˆëª… | features_v1ì´ ì‹¤ì œë¡œ 684ì¸ì§€ í™•ì¸ |

### 6.3 Minor (ê°œì„  ê¶Œì¥)

| ID | ê°œì„  ì‚¬í•­ | ì´ìœ  |
|----|-----------|------|
| **IMP-001** | window_id uniqueness ê²€ì¦ ì¶”ê°€ | ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ |
| **IMP-002** | balancing ì „í›„ ìƒì„¸ ë¡œê·¸ | ë””ë²„ê¹… ìš©ì´ì„± |
| **IMP-003** | ë¬¸ì„œ ìë™ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ | ë¬¸ì„œ-ì½”ë“œ ì¼ì¹˜ì„± ìœ ì§€ |

---

## 7. ê¶Œì¥ ìˆ˜ì • ì‚¬í•­

### 7.1 Oversampling ì œê±° (ìµœìš°ì„ )

**ëª©í‘œ**: ë³´ê³ ì„œ ëª…ì„¸ëŒ€ë¡œ "Oversampling ë¯¸ì‚¬ìš©" êµ¬í˜„

**ìˆ˜ì • 1: params_eda.yaml**
```yaml
balancing:
  apply_to_train_only: true
  target_ratio:
    normal: 1
    abnormal: 2
  method: "none"  # oversample â†’ none ë³€ê²½
  random_seed: 42
```

**ìˆ˜ì • 2: balance.py ë¡œì§ ìˆ˜ì •**
```python
def balance_train_windows(windows_df, params):
    balance_config = params.get('balancing', {})
    method = balance_config.get('method', 'none')

    if method == 'none':
        logger.info("Balancing disabled, using original distribution")
        return windows_df

    # ê¸°ì¡´ oversample/undersample ë¡œì§...
```

**ê²€ì¦**:
```python
# run_pipeline.py ì‹¤í–‰ í›„
windows = pd.read_parquet('data/processed/windows_balanced_v1.parquet')
train = windows[windows['split_set'] == 'train']

assert train['window_id'].nunique() == len(train), "window_id ì¤‘ë³µ ì¡´ì¬!"
print(f"âœ… No duplicate window_ids: {len(train)} unique")
```

### 7.2 window_id Uniqueness ê²€ì¦ ì¶”ê°€

**ìœ„ì¹˜**: `src/preprocess/balance.py` ëë¶€ë¶„

```python
def balance_train_windows(...):
    # ... ê¸°ì¡´ ë¡œì§ ...

    # Validation: Check for duplicate window_ids
    if result['window_id'].duplicated().any():
        n_duplicates = result['window_id'].duplicated().sum()
        logger.error(f"CRITICAL: {n_duplicates} duplicate window_ids detected!")

        # Log duplicate details
        duplicates = result[result['window_id'].duplicated(keep=False)]
        logger.error(f"Duplicate window_ids: {duplicates['window_id'].unique().tolist()[:10]}")

        raise ValueError("Duplicate window_ids found after balancing")

    logger.info(f"âœ… Validation passed: {result['window_id'].nunique()} unique window_ids")

    return result
```

### 7.3 Normal íŒŒì¼ ì •ì˜ ëª…í™•í™”

**ì¡°ì‚¬ í•„ìš”**:
1. ì›ë³¸ í”„ë¡œì íŠ¸ì—ì„œ Normal 11ê°œ íŒŒì¼ì˜ ê·¼ê±° ë¬¸ì„œ í™•ì¸
2. `params_eda.yaml` normal_samples ì—…ë°ì´íŠ¸
3. ë³´ê³ ì„œì™€ ì½”ë“œ ì¼ì¹˜ì‹œí‚¤ê¸°

**ì„ì‹œ ì¡°ì¹˜**:
```yaml
normal_samples:
  "100W": [0, 1, 5, 6]  # S00, S01, S05, S06
  "200W": [2, 3]        # S02, S03

  # ë˜ëŠ”

normal_samples:
  "100W": [0]  # S00ë§Œ (í˜„ì¬ ì„¤ì • ìœ ì§€)
  "200W": [3]  # S03ë§Œ (í˜„ì¬ ì„¤ì • ìœ ì§€)

# ì–´ëŠ ê²ƒì´ ë§ëŠ”ì§€ ëª…í™•íˆ ê²°ì • í•„ìš”
```

### 7.4 ë°ì´í„° íŒŒì¼ ë°±ì—… ë° ë²„ì „ ê´€ë¦¬

**ê¶Œì¥ í”„ë¡œì„¸ìŠ¤**:
```bash
# 1. ì›ë³¸ ë°ì´í„° ë°±ì—… (í•œ ë²ˆë§Œ)
mkdir -p data/raw_backup_original
cp -r data/100W data/200W data/raw_backup_original/

# 2. ì¤‘ê°„ ê²°ê³¼ ë²„ì „ ê´€ë¦¬
data/processed/
  features_combined_v1_20241117.parquet  # 898 windows (Phase3 ì›ë³¸)
  features_combined_v1_20241124.parquet  # 684 windows (ë³µì› í›„)

# 3. Git LFS ë˜ëŠ” DVC ì‚¬ìš© (ëŒ€ìš©ëŸ‰ íŒŒì¼ ë²„ì „ ê´€ë¦¬)
```

---

## 8. ì¬ì‹¤í–‰ ê³„íš

### 8.1 ìˆ˜ì • í›„ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì¬ì‹¤í–‰

**ë‹¨ê³„**:
```bash
# 1. ì„¤ì • ìˆ˜ì •
vi src/config/params_eda.yaml
# method: "none" ì„¤ì •

# 2. ê¸°ì¡´ ê²°ê³¼ ë°±ì—…
mkdir -p data/backup_before_fix_20241124
cp data/processed/*.parquet data/backup_before_fix_20241124/

# 3. íŒŒì´í”„ë¼ì¸ ì¬ì‹¤í–‰
python run_pipeline.py 2>&1 | tee data/interim/pipeline_fixed_20241124.log

# 4. ê²€ì¦
python -c "
import pandas as pd
windows = pd.read_parquet('data/processed/windows_balanced_v1.parquet')
train = windows[windows['split_set'] == 'train']
print(f'Train windows: {len(train)}')
print(f'Unique window_ids: {train[\"window_id\"].nunique()}')
assert train['window_id'].nunique() == len(train), 'FAIL: Duplicates exist'
print('âœ… PASS: No duplicates')
"

# 5. Phase2, Phase3 ì¬ì‹¤í–‰
python scripts/step3_3_add_band_rms.py
python scripts/step3_4_xgboost_v2_with_band_rms.py
python phase3/phase3_1_xgboost_core_band_rms.py

# 6. ê²°ê³¼ ë¹„êµ
python scripts/compare_results.py
```

### 8.2 ì˜ˆìƒ ê²°ê³¼

**Oversampling ì œê±° í›„**:
- Train windows: ~160 Normal, ~321 Abnormal (ì›ë³¸ ë¹„ìœ¨ ìœ ì§€)
- Unique window_ids = Total rows (ì¤‘ë³µ ì—†ìŒ)
- í´ë˜ìŠ¤ ë¶ˆê· í˜•: XGBoost scale_pos_weightë¡œë§Œ ì²˜ë¦¬

**ì„±ëŠ¥ ì˜í–¥ ì˜ˆì¸¡**:
- Train ë°ì´í„° ê°ì†Œ (695 â†’ 481) â†’ í•™ìŠµ ë°ì´í„° ë¶€ì¡±
- í•˜ì§€ë§Œ ì¤‘ë³µ ì œê±°ë¡œ **ì¼ë°˜í™” ì„±ëŠ¥ í–¥ìƒ** ê°€ëŠ¥ì„±
- Test AUC: 0.820 ìœ ì§€ ë˜ëŠ” ì†Œí­ ë³€ë™ ì˜ˆìƒ (Â±0.02)

---

## 9. ê²°ë¡ 

### 9.1 ì£¼ìš” ë°œê²¬

1. **Oversamplingì´ ì˜ë„ì™€ ë‹¤ë¥´ê²Œ í™œì„±í™”**ë˜ì–´ ìˆìŒ
2. **window_id ì¤‘ë³µ**ì´ ë°œìƒí•˜ì—¬ ë°ì´í„° ë¬´ê²°ì„± í›¼ì†
3. **ë¬¸ì„œì™€ ì½”ë“œ ë¶ˆì¼ì¹˜**ë¡œ ì¬í˜„ì„± ì €í•˜
4. **898 vs 684 windows ì°¨ì´**ì˜ ê·¼ë³¸ ì›ì¸ ë¶ˆëª… (ì¶”ê°€ ì¡°ì‚¬ í•„ìš”)

### 9.2 ìš°ì„ ìˆœìœ„ ì•¡ì…˜ ì•„ì´í…œ

| ìš°ì„ ìˆœìœ„ | ì•¡ì…˜ | ë‹´ë‹¹ | ì™„ë£Œ ê¸°í•œ |
|---------|------|------|----------|
| **P0** | `params_eda.yaml` method: "none" ìˆ˜ì • | Developer | ì¦‰ì‹œ |
| **P0** | `balance.py` uniqueness ê²€ì¦ ì¶”ê°€ | Developer | ì¦‰ì‹œ |
| **P0** | ì „ì²´ íŒŒì´í”„ë¼ì¸ ì¬ì‹¤í–‰ ë° ê²€ì¦ | Developer | ì˜¤ëŠ˜ |
| **P1** | Normal íŒŒì¼ ì •ì˜ ëª…í™•í™” (11ê°œ vs 4ê°œ) | Analyst | 1ì¼ ë‚´ |
| **P1** | 898 vs 684 windows ì°¨ì´ ì¡°ì‚¬ | Analyst | 2ì¼ ë‚´ |
| **P2** | ë¬¸ì„œ ì—…ë°ì´íŠ¸ (ì‹¤ì œ êµ¬í˜„ ë°˜ì˜) | Technical Writer | 3ì¼ ë‚´ |

### 9.3 ECMiner êµ¬í˜„ ê¶Œì¥ì‚¬í•­

í˜„ì¬ ë²„ê·¸ë¥¼ ëª¨ë‘ ìˆ˜ì •í•œ í›„, **ê²€ì¦ëœ íŒŒì´í”„ë¼ì¸ ê²°ê³¼**ë¥¼ ECMinerë¡œ êµ¬í˜„í•  ê²ƒì„ ê°•ë ¥íˆ ê¶Œì¥í•©ë‹ˆë‹¤.

**ì´ìœ **:
- ë²„ê·¸ê°€ ìˆëŠ” ìƒíƒœë¡œ ECMiner êµ¬í˜„ ì‹œ ë™ì¼í•œ ì˜¤ë¥˜ ì¬í˜„
- Oversampling ì œê±° í›„ ì„±ëŠ¥ ì¬í‰ê°€ í•„ìš”
- ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ í›„ GUI êµ¬í˜„ì´ ì•ˆì „

**ECMiner êµ¬í˜„ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸**:
- [ ] Oversampling ë²„ê·¸ ìˆ˜ì •
- [ ] window_id ì¤‘ë³µ ì œê±° í™•ì¸
- [ ] ì „ì²´ íŒŒì´í”„ë¼ì¸ ì¬ì‹¤í–‰ ì™„ë£Œ
- [ ] Phase3-1 ì„±ëŠ¥ ì¬í˜„ (Test AUC â‰¥ 0.80)
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ
